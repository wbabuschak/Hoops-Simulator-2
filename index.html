<!DOCTYPE html>

<head>
    <title>
        Pokemon Type Calculator
    </title>
    <link rel="icon" type="image/webp" href="icon.webp">
</head>


<script src="Type.js"></script>
<script>
    function navigate(destination){
        window.location.hash = destination;
        route();
    }
    function route(){
        const hash = decodeURIComponent(window.location.hash.substring(1));
        if (hash == "CREATELEAGUE"){
            showPage("createLeague");
        }   else if (hash == "EDITLEAGUE"){
            showPage("editLeague");
        }   else if (hash && league && league.teams.some(t => "TEAM-" + t.name == hash)) {
            showPage("teamView",hash);
        }   else {
            showPage("home");
        }
    }
    window.onhashchange = route;
    window.onload = function(){
        loadTypes();
        populateSelections();
        route();
    };
</script>

<script>
    let typeList;
    function saveTypes(){
       if (!typeList) return;
        localStorage.setItem("typeList", JSON.stringify(typeList.map(
            t => ({
                name: t.name,
                immune: t.immune,
                resist: t.resist,
                weakTo: t.weakTo
            }))
        ));
    }
    function loadTypes(){
        const data = localStorage.getItem("typeList");
        if (data) {
            const arr = JSON.parse(data);
            typeList = arr.map(obj => new Type(obj.name, obj.immune, obj.resist, obj.weakTo))
        } else {
            typeList = Type.defaultTypeList;
        }
    }
</script>

<script>
    function showPage(type, hash = ""){
        document.getElementById("home").style.display = "none";
        document.getElementById("create").style.display = "none";
        switch (type){
            case "home":
                showHome();
                showCreateType();
                break;
            case "createLeague":
                showCreateLeague();
                break;
            case "editLeague":
                showEditLeague();
                break;
            case "teamView":
                showTeamView(hash);
                break;
        }
    }

    function showHome(){
        document.getElementById("home").style.display = "block";
        showTypeChart();
    }
    
    function showCreateType(){
        document.getElementById("create").style.display = "block";
    }

    function showTeamView(hash){
        if (!leagueFound()){
            showHome();
            return;
        }
        document.getElementById("teamView").style.display = "block";
        const teamName = decodeURIComponent(hash.replace(/^TEAM-/,""));
        document.getElementById("lblTeamNameTeamView").innerHTML = teamName;

        const team = league.teams.find(t => t.name == teamName);
        showCurrentRoster(team);
    }

    function showTypes() {
        const container = document.getElementById("typesContainer");
        const tbody = document.getElementById("typesTable").querySelector("tbody");
        tbody.innerHTML = "";

        typeList.forEach(
            type => {
                const row = document.createElement("tr");

                const nameCell = document.createElement("td");
                nameCell.textContent = type.name;
                row.appendChild(nameCell);

                const immuneCell = document.createElement("td");
                immuneCell.textContent = "[" + type.immune.join(" ") + "]";
                row.appendChild(immuneCell);

                const resistCell = document.createElement("td");
                resistCell.textContent = "[" + type.resist.join(" ") + "]";
                row.appendChild(resistCell);

                const weakCell = document.createElement("td");
                weakCell.textContent = "[" + type.weakTo.join(" ") + "]";
                row.appendChild(weakCell);

                tbody.appendChild(row);
            }
        )
        container.style.display = "block";
    }

    function showTypeChart() {
        const container = document.getElementById("typeChartContainer");
        const tbody = document.getElementById("typeChart").querySelector("tbody");
        const hrow = document.getElementById("typeChartHeader");

        const blank = document.createElement("th");
        hrow.appendChild(blank);

        tbody.innerHTML = "";
        typeList.forEach(
            type => {
                const column = document.createElement("th");
                column.textContent = type.name;
                hrow.appendChild(column);
            }
        )

        typeList.forEach(
            type => {
                const row = document.createElement("tr");

                const nameCell = document.createElement("td");
                nameCell.textContent = type.name;
                row.appendChild(nameCell);

                typeList.forEach(
                    tarType => {
                        const multCell = document.createElement("td");
                        let mult;
                        let color = "#dadada";
                        if (type.immune.includes(tarType.name)){
                            mult = "0x";
                            color = "#d1a0ff";
                        } else if (type.resist.includes(tarType.name)){
                            mult = "1/2x";
                            color = "#a3ffa0";
                        } else if (type.weakTo.includes(tarType.name)){
                            mult = "2x";
                            color = "#ffa0a0";
                        } else {
                            mult = "1x";
                        }
                        multCell.textContent = mult;
                        multCell.style.backgroundColor = color;
                        row.appendChild(multCell);
                    }
                )
                

                tbody.appendChild(row);
            }
        )
        container.style.display = "block";
    }

     function showCurrentRoster(team) {
        const container = document.getElementById("rosterContainer");
        const tbody = document.getElementById("rosterTable").querySelector("tbody");
        tbody.innerHTML = "";

        team.roster.players.forEach(
            player => {
                const row = document.createElement("tr");
                const nameCell = document.createElement("td");

                const link = document.createElement("a");
                link.href = "#PLAYER-" + encodeURIComponent(player.id);
                link.textContent = player.name;
                nameCell.appendChild(link);

                row.appendChild(nameCell);

                const minutesCell = document.createElement("td");
                minutesCell.textContent = league.seasonPlayerTotal(player.id,"minutes");
                row.appendChild(minutesCell);

                const pointsCell = document.createElement("td");
                pointsCell.textContent = league.seasonPlayerTotal(player.id,"points");
                row.appendChild(pointsCell)

                const reboundsCell = document.createElement("td");
                reboundsCell.textContent = league.seasonPlayerTotal(player.id,"rebounds");
                row.appendChild(reboundsCell)

                const assistsCell = document.createElement("td");
                assistsCell.textContent = league.seasonPlayerTotal(player.id,"assists");
                row.appendChild(assistsCell)

                const stealsCell = document.createElement("td");
                stealsCell.textContent = league.seasonPlayerTotal(player.id,"steals");
                row.appendChild(stealsCell)

                const blocksCell = document.createElement("td");
                blocksCell.textContent = league.seasonPlayerTotal(player.id,"blocks");
                row.appendChild(blocksCell)

                const turnoversCell = document.createElement("td");
                turnoversCell.textContent = league.seasonPlayerTotal(player.id,"turnovers");
                row.appendChild(turnoversCell)

                tbody.appendChild(row);
            }
        )
        container.style.display = "block";
    }
</script>

<script>
    function saveType(){
        const form = document.getElementById("formTypeCreate");
        const immuneSelect = document.getElementById("immuneSelect");
        const resistSelect = document.getElementById("resistSelect");
        const weaknessSelect = document.getElementById("weaknessSelect");

        const name = form.elements.typeName.value.trim();
        if (!name){
            alert("Failed to create Type.")
            return;
        }
        let type = new Type(name);
        Array.from(immuneSelect.selectedOptions).map(opt => opt.value).forEach(immune => type.immune.push(immune));
        Array.from(resistSelect.selectedOptions).map(opt => opt.value).forEach(resist => type.resist.push(resist));
        Array.from(weaknessSelect.selectedOptions).map(opt => opt.value).forEach(weakTo => type.weakTo.push(weakTo));

        const oldIndex = typeList.indexOf(typeList.find(t => t.name == name));
        if (oldIndex != -1){
            typeList[oldIndex] = type;
        } else {
            typeList.push(type);
        }
        saveTypes();
        location.reload();
        
    }

    function loadType(){
        populateSelections();
        const form = document.getElementById("formTypeCreate");
        const immuneSelect = document.getElementById("immuneSelect");
        const resistSelect = document.getElementById("resistSelect");
        const weaknessSelect = document.getElementById("weaknessSelect");

        const name = form.elements.typeName.value.trim();
        const type = typeList.find(t => t.name == name);
        if (!type){
            alert("No existing type of that name")
            return;
        }
        for (let option of immuneSelect.options) {
            
            console.log(immuneSelect.options);
            option.selected = type.immune.includes(option.value);
        }
        for (let option of resistSelect.options) {
            
            console.log(resistSelect.options);
            option.selected = type.resist.includes(option.value);
        }
        for (let option of weaknessSelect.options) {
            
            console.log(weaknessSelect.options);
            option.selected = type.weakTo.includes(option.value);
        }
        
    }

    function resetTypes(){
        typeList = Type.defaultTypeList;
        saveTypes();
        location.reload();
    }

    function editLeague(){
        const form = document.getElementById("formLeagueEdit");

        const name = form.elements.leagueName.value;
        const seasonLength = parseInt(form.elements.seasonLength.value);
        const noTeams = parseInt(form.elements.noTeams.value);
        if (name && seasonLength && noTeams){

            league.seasonLength = seasonLength;
            league.name = name;
            league.noTeams = noTeams;

            saveLeague();
            navigate('');
        } else {
            alert("Failed to edit league.")
        }
    }

    function leagueFound(){
        return league != null;
    }
    
</script>


<body>
    <h1>Pokemon Type Calculator</h1>
    <h2>By William Babuschak</h2>
    </script>
    <div id="home">
        <p id="txtLeagueName"></p>
        <button id="btnResetTypes" onclick="resetTypes()">Reset Types</button><br>
        <div id="typesContainer" style ="display:none;">
            <h3>Types</h3>
            <table id="typesTable">
                <thead>
                    <tr>
                        <th>Type Name</th>
                        <th>Immunities</th>
                        <th>Resistances</th>
                        <th>Weaknesses</th>
                    </tr>
                </thead>
                <tbody>

                </tbody>
            </table>
        </div>

        <div id="typeChartContainer" style ="display:none;">
            <h3>Type Chart</h3>
            <table id="typeChart">
                <thead>
                    <tr id="typeChartHeader"></tr>
                </thead>
                <tbody>

                </tbody>
            </table>
        </div>
    </div>

    <div id="create">
        <form id="formTypeCreate" style="display:flex">
            <label for="type-name">Type Name</label><br>
            <input type="text" id="typeName" name="typeName" required><br>

            <label for="type-immune">Immunities</label><br>
            <select id="immuneSelect" name="immuneType" multiple></select><br>
            
            <label for="type-resist">Resistances</label><br>
            <select id="resistSelect" name="resistType" multiple></select><br>

            <label for="type-weakness">Weaknesses</label><br>
            <select id="weaknessSelect" name="weaknessType" multiple></select><br>

            <button id="btnSaveType" onclick="saveType()">Save Type</button><br>
        </form>
        <button id="btnLoadType" onclick="loadType()">Load Type</button><br>
    </div>

    <script>
        function populateSelections() {
            ["immuneSelect","resistSelect","weaknessSelect"].forEach(id => {
                document.getElementById(id).innerHTML = "";
                typeList.forEach(type => {
                    const option = document.createElement("option");
                    option.value = type.name;
                    option.textContent = type.name;
                    document.getElementById(id).appendChild(option);
                    
                })
                document.getElementById(id).size = document.getElementById(id).options.length;
            });
        }
    </script>

</body>

</html>